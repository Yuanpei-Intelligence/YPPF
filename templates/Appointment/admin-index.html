{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>我的预约 | 元培地下空间</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
        <!-- Favicons -->
        <link type="image/x-icon" href="{% static 'Appointment/assets/img/yp_favicon.png' %} " rel="icon">
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="{% static 'Appointment/assets/css/bootstrap.min.css' %}">
        <!-- Fontawesome CSS -->
        <link rel="stylesheet" href="{% static 'Appointment/assets/plugins/fontawesome/css/fontawesome.min.css' %}">
        <link rel="stylesheet" href="{% static 'Appointment/assets/plugins/fontawesome/css/all.min.css' %}">
        <!-- Fancybox CSS -->
        <link rel="stylesheet" href="{% static 'Appointment/assets/plugins/fancybox/jquery.fancybox.min.css' %}">
        <!-- Main CSS -->
        <link rel="stylesheet" href="{% static 'Appointment/assets/css/style.css' %}">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
			<script src="assets/js/html5shiv.min.js"></script>
			<script src="assets/js/respond.min.js"></script>
		<![endif]-->
    </head>
    <body>
        <!-- Main Wrapper -->
        <div class="main-wrapper">
            <!-- Header -->
            <header class="header">
                <nav class="navbar navbar-expand-lg header-nav">
                    <div class="navbar-header">
                        <a id="mobile_btn" href="javascript:void(0);">
                            <span class="bar-icon">
                                <span></span>
                                <span></span>
                                <span></span>
                            </span>
                        </a>
                        <a href="index" class="navbar-brand logo">
                            <img src="{% static 'Appointment/assets/img/yp_name_red.png' %} " class="img-fluid" alt="Logo">
                        </a>
                    </div>
                    <div class="main-menu-wrapper">
                        <div class="menu-header">
                            <a href="index" class="menu-logo">
                                <img src="{% static 'Appointment/assets/img/yuan_logo_red.png' %}" class="img-fluid" alt="Logo">
                            </a>
                            <a id="menu_close" class="menu-close" href="javascript:void(0);">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                        <ul class="main-nav">
                            <li>
                                <a href="index">主页</a>
                            </li>
                            <li class="active">
                                <a href="admin-index.html">我的账户</a>
                                <!--<a href="admin/index.html" target="_blank">Admin</a>-->
                            </li>
                            <li>
                                <a href="agreement">无占座协议</a>
                            </li>
                            <li>
								<a href="instructions">使用规范</a>
							</li>
                            <li>
                                <a href="/">成长档案</a>
                            </li>
                            {% if show_admin %}
                                <li>
                                    <a href="/admin">管理后台</a>
                                </li>
                            {% endif %}
                            <li class="login-link">
                                <a href="logout">注销</a>
                            </li>
                        </ul>
                    </div>
                    <ul class="nav header-navbar-rht">
                        <li class="nav-item">
                            <a class="nav-link header-login" href="logout">注销</a>
                        </li>
                    </ul>
                </nav>
            </header>
            <!-- /Header -->
            <!-- Page Content -->
            <div class="content">
                <div class="container-fluid">
                    {% if warn_code == 1 %}
                        <div class="alert alert-warning  text-center">{{ warn_message }}</div>
                    {% elif warn_code == 2 %}
                        <div class="alert alert-success  text-center">{{ warn_message }}</div>
                    {% endif %}
                    <div class="row">
                        <div class="col-md-5 col-lg-4 col-xl-3 theiaStickySidebar">
                            <!-- Profile Sidebar -->
                            <div class="profile-sidebar">
                                <div class="widget-profile pro-widget-content">
                                    <div class="profile-info-widget">
                                        <a href="#" class="booking-doc-img">
                                            <img src="{{ img_path }}" alt="User Image">
                                        </a>
                                        <div class="profile-det-info">
                                            <h3>
                                                {{ my_info.name }}
                                                {% if my_info.agree_time %}
                                                    <span id="ret" class="badge badge-pill badge-success">已签署协议</span>
                                                {% else %}
                                                    <span id="ret" class="badge badge-pill badge-danger">未签署协议</span>
                                                {% endif %}
                                            </h3>
                                            <div class="patient-details">
                                                <h5 class="mb-0">{{ my_info.id }}</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="dashboard-widget">
                                    <nav class="dashboard-menu">
                                        <ul>
                                            <li class="active">
                                                <a href="admin-index.html">
                                                    <i class="fas fa-calendar-check"></i>
                                                    <span>我的预约</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="admin-credit.html">
                                                    <i class="fas fa fa-star"></i>
                                                    <span>信用分</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                            <!-- /Profile Sidebar -->
                        </div>
                        <div class="col-md-7 col-lg-8 col-xl-9">
                            <div class="card">
                                <div class="card-body">
                                    {% comment %} tab buttons {% endcomment %}
                                    <ul class="nav nav-tabs nav-tabs-solid nav-justified">
                                        {% if has_longterm_permission %}
                                            <li class="nav-item">
                                                <a class="nav-link active" href="#appoint-longterm" data-toggle="tab">长期预约</a>
                                            </li>
                                        {% endif %}
                                        <li class="nav-item">
                                            <a class="nav-link {{ has_longterm_permission | yesno:',active' }}" href="#appoint-future" data-toggle="tab">{{ has_longterm_permission | yesno:'普通预约,未开始的预约' }}</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#appoint-past" data-toggle="tab">过去一周</a>
                                        </li>
                                    </ul>
                                    {% if not has_longterm_permission %}
                                        <div class="d-flex px-3 align-items-center mt-3" style="height:1rem">
                                            <div class="flex-fill">
                                                <label for="only-major" style="font-size:13px;">
                                                    <input type="checkbox" id="only-major" style="vertical-align: text-bottom;">
                                                    仅显示自己发起的预约
                                                </label>
                                            </div>
                                            <div class="flex-fill">
                                                <label for="no-longterm" style="font-size:13px;">
                                                    <input type="checkbox" id="no-longterm" style="vertical-align: text-bottom;">      
                                                    不显示长期预约</label>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% comment %} tab content {% endcomment %}
                                    <div class="tab-content">
                                        {% if has_longterm_permission %}
                                            <div class="tab-pane show active" id="appoint-longterm">
                                                <div class="alert alert-primary alert-dismissible fade show" role="alert">
                                                    本学期你已发起
                                                    <strong>{{ longterm_count }}</strong>
                                                    条长期预约
                                                </div>
                                                <div class="w-100 d-flex">
                                                    {% if is_full %}
                                                        <a class="btn btn-secondary w-100 mb-3 text-light" disabled>您的预约数量已达上限</a>
                                                    {% else %}
                                                        <a class="btn btn-primary w-100 mb-3" href="/underground/arrange_time?Rid=B107A&start_week=0">添加长期预约</a>
                                                    {% endif %}
                                                </div>
                                                <div class="appointments">
                                                    {% for appoint_longterm in appoint_list_longterm %}
                                                        <!-- Appointment List -->
                                                        <div class="appointment-list">
                                                            <div class="profile-info-widget">
                                                                <div class="profile-det-info">
                                                                    <h3 style="white-space: normal;">
                                                                        {{ appoint_longterm.appoint.Rid }}
                                                                        {{ appoint_longterm.appoint.Rtitle }}
                                                                    </h3>
                                                                    <div class="patient-details">
                                                                        <h5 style="white-space: normal;">
                                                                            <i class="far fa-clock" style="word-break:break-all"></i>
                                                                            预约时间：{{ appoint_longterm.appoint.Aweek|slice:":3" }}
                                                                            <!--modified by wxy-->
                                                                            {{ appoint_longterm.appoint.Astart_hour_minute }}-{{ appoint_longterm.appoint.Afinish_hour_minute }}
                                                                        </h5>
                                                                        <h5 style="white-space: normal;">
                                                                            <i class="far fa-calendar" style="word-break:break-all"></i>
                                                                            开始日期：{{appoint_longterm.appoint.Astart|slice:":10"}} 起 
                                                                        </h5>
                                                                        <h5 style="white-space: normal;">
                                                                            <i class="far fa fa-bell"></i>
                                                                            预约周数：
                                                                            {% if appoint_longterm.interval == 1 %} 每周一次，
                                                                            {% elif appoint_longterm.interval == 2 %} 隔周一次，
                                                                            {% else %} 每 {{ appoint_longterm.interval }} 周一次，
                                                                            {% endif %} 
                                                                            共 {{  appoint_longterm.times }} 次
                                                                        </h5>
                                                                        <h5 style="white-space: normal;">
                                                                            <i class="fas fa fa-comments"></i>
                                                                            用途：{{  appoint_longterm.appoint.Ausage }}
                                                                        </h5>
                                                                        {% if  appoint_longterm.appoint.Aannouncement %}
                                                                            <h5 style="white-space: normal;">
                                                                                <i class="fas fa fa-envelope"></i>
                                                                                预约通知：{{  appoint_longterm.appoint.Aannouncement }}
                                                                            </h5>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="appointment-action flex-column align-items-start">
                                                                {% if  appoint_longterm.status == "审核中" %}
                                                                    <button type="button" class="btn btn-sm bg-primary-light" style="width: 6rem;" value="{{  appoint_longterm.appoint.Aid }}">
                                                                        <i class="fas fa-hourglass-half"></i> 审核中
                                                                    </button>
                                                                {% elif  appoint_longterm.status == "未通过" %}
                                                                        <button type="button"
                                                                                class="btn btn-sm bg-danger-light"
                                                                                style="width: 6rem;"
                                                                                data-container="body" 
                                                                                data-toggle="popover" 
                                                                                data-placement="bottom" 
                                                                                data-content="审核意见：{{ appoint_longterm.review_comment }}"
                                                                                >
                                                                                <i class="fas fa-ban"></i> 未通过
                                                                        </button>
                                                                        <button type="button"
                                                                                class="btn btn-sm bg-danger-light mt-3"
                                                                                style="width: 6rem;visibility:hidden">
                                                                        </button>
                                                                {% elif  appoint_longterm.status == "已通过" and not appoint_longterm.renewable %}
                                                                    <button type="button" class="btn btn-sm bg-success-light" style="width: 6rem;">
                                                                        <i class="fas fa-check"></i> 已通过
                                                                    </button>
                                                                {% elif  appoint_longterm.status == "已通过" and  appoint_longterm.renewable %}
                                                                    <button type="button"
                                                                        class="btn btn-sm bg-warning-light mt-3"
                                                                        style="width: 6rem;"
                                                                        data-container="body" 
                                                                        data-toggle="popover" 
                                                                        data-placement="bottom"
                                                                        data-content="<form action='renewLongtermAppoint' method='POST' class='d-flex'>
                                                                                        <input class='form-control form-control-sm flex-fill h-100 p-1' 
                                                                                               style='min-height:0;max-width:11rem;' 
                                                                                               type='text' name='times' value='' 
                                                                                               placeholder='续约周数：最多可续约8周'/>
                                                                                        <button class='btn btn-sm btn-primary d-inline  h-100 ml-2' 
                                                                                                type='submit' 
                                                                                                value='{{ appoint_longterm.longterm_id }}'
                                                                                                name='longterm_id'
                                                                                                >确认</button>
                                                                                      </form>"
                                                                        >
                                                                        <i class="fas fa-sync"></i> 续约
                                                                    </button>
                                                                {% elif  appoint_longterm.status == "已取消" %}
                                                                    <a class="btn btn-sm bg-danger-light" style="width: 6rem;" >
                                                                        <i class="fas fa-undo-alt"></i> 已取消
                                                                    </a>
                                                                    <button type="button"
                                                                            class="btn btn-sm bg-danger-light mt-3"
                                                                            style="width: 6rem;visibility:hidden">
                                                                    </button>
                                                                {% endif %}
                                                                {% if appoint_longterm.status != "已取消" and appoint_longterm.status != "未通过" %}
                                                                    <form action="cancelAppoint" method="POST" onsubmit="return confirm('确定取消对{{ appoint_longterm.appoint.Rtitle }}的长期预约?所有未开始的预约都将失效!')">
                                                                        <input type="hidden" name="type" value="longterm"/>
                                                                        <button type="submit"
                                                                                class="btn btn-sm bg-danger-light mt-3"
                                                                                style="width: 6rem;"
                                                                                name="cancel_id"
                                                                                value="{{  appoint_longterm.longterm_id }}">
                                                                            <i class="fas fa-times"></i> 取消预约
                                                                        </button>
                                                                    </form>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <!-- /Appointment List -->
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        <div class="tab-pane {{ has_longterm_permission | yesno:',show active' }}" id="appoint-future">
                                            <div class="alert alert-primary alert-dismissible fade show" role="alert">
                                                你最近有
                                                <strong>{{ appoint_list_future|length }}</strong>
                                                条待进行的预约
                                            </div>
                                            <div class="appointments">
                                                {% for appoint in appoint_list_future %}
                                                    <!-- Appointment List -->
                                                    <div class="appointment-list {{ appoint.is_appointer|yesno:'my-appoint,'}} {% if appoint.Atype == '长期预约' %}longterm{% endif %}">
                                                        <div class="profile-info-widget">
                                                            <div class="profile-det-info">
                                                                <h3 style="white-space: normal;">
                                                                    {{ appoint.Rid }}
                                                                    {{ appoint.Rtitle }}
                                                                </h3>
                                                                <div class="patient-details">
                                                                    <h5 style="white-space: normal;">
                                                                        <i class="far fa-clock" style="word-break:break-all"></i>
                                                                        预约时间：{{ appoint.Astart|slice:"5:7" }}月{{ appoint.Astart|slice:"8:10" }}日
                                                                        <!--modified by wxy-->
                                                                        {{ appoint.Astart_hour_minute }}-{{ appoint.Afinish_hour_minute }}
                                                                    </h5>
                                                                    <h5 style="white-space: normal;">
                                                                        <i class="fas fa fa-comments"></i>
                                                                        用途：{{ appoint.Ausage }}
                                                                    </h5>
                                                                    <h5 style="white-space: normal;">
                                                                        <i class="fas fa fa-street-view"></i>
                                                                        发起者：{{ appoint.major_student.Sname }}
                                                                    </h5>
                                                                    <h5 style="white-space: normal;">
                                                                        <i class="far fa fa-child"></i>
                                                                        人数：本院 {{ appoint.yp_num }} 人，非本院 {{ appoint.non_yp_num }} 人
                                                                    </h5>
                                                                    {% if appoint.Aannouncement %}
                                                                        <h5 style="white-space: normal;">
                                                                            <i class="fas fa fa-envelope"></i>
                                                                            预约通知：{{ appoint.Aannouncement }}
                                                                        </h5>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% if appoint.can_cancel %}
                                                            <form action="cancelAppoint" method="POST" onsubmit="return confirm('确定取消对{{ appoint.Rtitle }}的预约?')">
                                                                <div class="appointment-action">
                                                                    <input type="hidden" name="type" value="appoint"/>
                                                                    <button type="submit" class="btn btn-sm bg-danger-light" name="cancel_id" value="{{ appoint.Aid }}">
                                                                        <i class="fas fa-times"></i> 取消预约
                                                                    </input>
                                                                </div>
                                                            </form>
                                                        {% endif %}
                                                    </div>
                                                    <!-- /Appointment List -->
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="appoint-past">
                                            <div class="appointments">
                                                {% for appoint in appoint_list_past %}
                                                    <!-- Appointment List -->
                                                    <div class="appointment-list {{ appoint.is_appointer|yesno:'my-appoint,'}} {% if appoint.Atype == '长期预约' %}longterm{% endif %}">
                                                        <div class="profile-info-widget">
                                                            <div class="profile-det-info">
                                                                <h3 style="white-space: normal;">
                                                                    {{ appoint.Rid }}
                                                                    {{ appoint.Rtitle }}&nbsp;&nbsp;&nbsp;&nbsp;
                                                                    <!--本来想直接通过模版引用变量上色的，但一直写不对，就暂且用分支语句吧-->
                                                                    <!--modified by wxy-->
                                                                    {% if appoint.Astatus == '已取消' %}
                                                                        <span style="color:#79380e">已取消</span>
                                                                    {% elif appoint.Astatus == '已预约' %}
                                                                        <span style="color:#08daff">已预约</span>
                                                                    {% elif appoint.Astatus == '进行中' %}
                                                                        <span style="color:#1e90ff">正在进行</span>
                                                                    {% elif appoint.Astatus == '等待确认' %}
                                                                        <span style="color:#e97313">等待确认</span>
                                                                    {% elif appoint.Astatus == '已确认' %}
                                                                        <span style="color:#32ac0d">已确认</span>
                                                                    {% elif appoint.Astatus == '违约' %}
                                                                        <span style="color:#ff2d2d">违规（可申诉）</span>
                                                                    {% elif appoint.Astatus == '申诉成功' %}
                                                                        <span style="color:#32ac0d">违规申诉成功</span>
                                                                    {% endif %}
                                                                </h3>
                                                                <div class="patient-details">
                                                                    <h5 style="white-space: normal;">
                                                                        <i class="far fa-clock"></i>
                                                                        预约时间：{{ appoint.Astart|slice:"5:7" }}月{{ appoint.Astart|slice:"8:10" }}日
                                                                        <!--modified by wxy-->
                                                                        {{ appoint.Astart_hour_minute }}-{{ appoint.Afinish_hour_minute }}
                                                                    </h5>
                                                                    <h5 style="white-space: normal;">
                                                                        <i class="fas fa fa-comments "></i>
                                                                        用途：{{ appoint.Ausage }}
                                                                    </h5>
                                                                    <h5 style="white-space: normal;">
                                                                        <i class="fas fa fa-street-view"></i>
                                                                        发起者：{{ appoint.major_student.Sname }}
                                                                    </h5>
                                                                    <h5 style="white-space: normal;">
                                                                        <i class="far fa fa-child"></i>
                                                                        人数：院内{{ appoint.yp_num }}人，院外{{ appoint.non_yp_num }}人
                                                                    </h5>
                                                                    {% if appoint.Aannouncement != "" %}
                                                                        {% if appoint.Aannouncement != null %}
                                                                            <h5 style="white-space: normal;">
                                                                                <i class="far fa fa-envelope"></i>
                                                                                预约通知：{{ appoint.Aannouncement }}
                                                                            </h5>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                    {% if appoint.Astatus == '违约' %}
                                                                        <h5 style="white-space: normal;color:#ff2d2d">
                                                                            <i class="far fa fa-envelope"></i>
                                                                            违约原因：
                                                                            {% if appoint.Areason == 0 %}
                                                                                异常状况，请联系管理员
                                                                            {% elif appoint.Areason == 1 %}
                                                                                预约开始后15分钟内未到场且使用人数不足
                                                                            {% elif appoint.Areason == 2 %}
                                                                                使用人数不足登记人数
                                                                            {% elif appoint.Areason == 3 %}
                                                                                未知原因，请联系管理员
                                                                            {% endif %}
                                                                        </h5>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            {% if appoint.Astatus == '违约' %}
                                                                <form method="POST">
                                                                    <div class="appointment-action">
                                                                        <button type="submit" class="btn btn-sm bg-danger-light"
                                                                            name="feedback" value="{{appoint.Aid}}">
                                                                            <i class="fa fa-times"></i> 我要申诉
                                                                        </button>
                                                                    </div>
                                                                <form>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <!-- /Appointment List -->
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /Page Content -->
            <!-- Footer -->
            <footer class="footer">
                <!-- Footer Bottom -->
                <div class="footer-bottom">
                    <div class="container-fluid">
                        <!-- Copyright -->
                        <div class="copyright">
                            <div class="row">
                                <div class=" col-lg-1">
                                    <div class="footer-logo">
                                        <img src="{% static 'Appointment/assets/img/yuan_logo_white.png' %} " alt="logo">
                                    </div>
                                </div>
                                <div class=" col-lg-11">
                                    <!-- Copyright Menu -->
                                    <div class="copyright-menu">
                                        <ul class="policy-menu">
                                            <li>
                                                <a href="https://github.com/Yuanpei-Intelligence/YPPF">智慧校园开发组 元培学院</a>
                                            </li>
                                        </ul>
                                        <ul class="policy-menu">
                                            <li>
                                                <a>&copy; All rights Reserved.</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <!-- /Copyright Menu -->
                                </div>
                            </div>
                        </div>
                        <!-- /Copyright -->
                    </div>
                </div>
                <!-- /Footer Bottom -->
            </footer>
            <!-- /Footer -->
        </div>
        <!-- /Main Wrapper -->
        <!-- jQuery -->
        <script src="{% static 'Appointment/assets/js/jquery.min.js' %}"></script>
        <!-- Bootstrap Core JS -->
        <script src="{% static 'Appointment/assets/js/popper.min.js' %}"></script>
        <script src="{% static 'Appointment/assets/js/bootstrap.min.js' %}"></script>
        <!-- Sticky Sidebar JS -->
        <script src="{% static 'Appointment/assets/plugins/theia-sticky-sidebar/ResizeSensor.js' %}"></script>
        <script src="{% static 'Appointment/assets/plugins/theia-sticky-sidebar/theia-sticky-sidebar.js' %}"></script>
        <!-- Circle Progress JS -->
        <script src="{% static 'Appointment/assets/js/circle-progress.min.js' %}"></script>
        <script src="{% static 'Appointment/assets/plugins/fancybox/jquery.fancybox.min.js' %}"></script>
        <!-- Custom JS -->
        <script src="{% static 'Appointment/assets/js/script.js' %}"></script>
        <script>
            $(function () {
                // 未通过和续约的按钮弹出框初始化
                $('[data-toggle="popover"]').popover({
                    html: true,
                    sanitize: false
                })
                
                {% if not has_longterm_permission %}
                // 个人用户页面根据条件过滤预约条目
                function filter(hideLongterm, hideOther){
                    $(".appointment-list").removeClass("d-none")
                    if(hideLongterm){
                        $(".appointment-list.longterm").addClass("d-none")
                    }
                    if(hideOther){
                        $(".appointment-list:not(.my-appoint)").addClass("d-none")
                    }
                }
                $('#no-longterm').on("change",() => filter($('#no-longterm').is(':checked'), $('#only-major').is(':checked')))
                $('#only-major').on("change", () => filter($('#no-longterm').is(':checked'), $('#only-major').is(':checked')))
                {% endif %}
            })
        </script>
    </body>
</html>
