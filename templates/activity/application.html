{% extends "base.html" %}

{% load static %}

{% block add_css_file %}
<link href={% static "datetimepicker/css/bootstrap-datetimepicker-standalone.css" %} rel="stylesheet" type="text/css" />
<link href={% static "datetimepicker/css/bootstrap-datetimepicker.css" %} rel="stylesheet" type="text/css" />
<link href={% static "datetimepicker/css/bootstrap-datetimepicker.min.css" %} rel="stylesheet" type="text/css" />


<style class="text/css">
    h5{
        font-family: 'Nunito', sans-serif;
        font-size: 1rem;
        font-weight: bold;
    }
</style>

{% endblock %}

{% block mainpage %}
    <!--  BEGIN CONTENT AREA  -->
    <div id="content" class="main-content">
        <div class="container">
            
                {% if html_display.warn_code == 2 %}
                <div class="alert alert-success  text-center" id="success_msg" >{{ html_display.warn_message }}</div>
                {% else %}
                <div class="alert alert-success  text-center" id="success_msg" style="display: none;"></div>
                {% endif %}
                {% if html_display.warn_code == 1 %}
                <div class="alert alert-warning  text-center" id="warn_msg" >{{ html_display.warn_message }}</div>
                {% else %}
                <div class="alert alert-warning  text-center" id="warn_msg" style="display: none;">test</div>
                {% endif %}


                <div class="row layout-top-spacing">
                    {% if bar_display.help_paragraphs %}
                        {% include 'help_with_table.html' %}
                    {% endif %}
                    <div class="col-lg-12 col-sm-12 col-12 layout-spacing">
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <div class="statbox widget box box-shadow">

                                    <!--  BEGIN HEADER AREA  -->
                                    <div class="widget-header">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                {% if edit or examine %}
                                                <h4 onclick="javascript:window.location.href='/viewActivity/{{aid}}'">
                                                    {% if edit %}
                                                        活动编辑 
                                                    {% elif examine %}
                                                        活动立项
                                                    {% endif %}
                                                    {% if status == "等待中" %}
                                                        <span id="ret" class="badge badge-pill badge-info">等待开始</span>
                                                    {% elif status == "审核中" %}
                                                        <span id="ret" class="badge badge-pill badge-warning">审核中</span>
                                                    {% elif status == "报名中" or status == "进行中" %}
                                                        <span id="ret" class="badge badge-pill badge-success">{{status}}</span>
                                                    {% else %}
                                                        <span id="ret" class="badge badge-pill badge-danger">{{status}}</span>
                                                    {% endif %}
                                                <a data-toggle="tooltip" data-placement="bottom" title="点击活动状态按钮可以返回活动详情页">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                        class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                        <path
                                                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                    </svg>
                                                </a>
                                                </h4>
                                                {% else %}
                                                <h4>活动发起</h4>
                                                {% endif %}
                                            </div>
                                            <div >
                                                <h4>
                                                <img src="{{ html_display.app_avatar_path }}" width="24" height="24" alt="avatar">                
                                                <a href='/orginfo/?name={{html_display.applicant_name}}'>
                                                    <u>{{html_display.applicant_name}}</u>
                                                </a>
                                                </h4>
                                            </div>
                                        </div>
                                        
                                    </div>

                                    <!--  BEGIN CONTENT AREA  -->
                                    <div class="widget-content widget-content-area">

                                        <form role="form" method="POST" enctype="multipart/form-data" onsubmit="return check_inputs()">
                                            <p>
                                                活动信息
                                                <a data-toggle="tooltip" data-placement="bottom" title="填写活动的基本信息；注意：预算、名称在审核通过后不能修改">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                        class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                        <path
                                                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                    </svg>
                                                </a>
                                            </p>
                                            <div class="form-group">
                                                <label>活动名称</label>
                                                <input type="text" id="title" name="title" class="form-control"
                                                    aria-label="Default" placeholder="取一个贴切的活动名称吧~" required="required" 
                                                    maxlength=50 onclick="fill_value(this)">
                                            </div>
                                            <div class="form-group">
                                                <label>活动地点</label>
                                                <input type="text" id="location" name="location" class="form-control"
                                                    aria-label="Default" placeholder="要让参加活动的同学能找到活动地点哦~" required="required" maxlength=200 onclick="fill_value(this)">
                                            </div>
                                            <div class="form-group">
                                                <label>活动时间</label>
                                                <a data-toggle="tooltip" data-placement="bottom" title="请选择合理的活动时间，持续时间过长将导致参与者无法获取积分！">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                        class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                        <path
                                                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                    </svg>
                                                </a>
                                                <div class="row">
                                                    <div class="col">
                                                        <input type="text" class="form-control" id="datetimepicker3"
                                                            name="actstart" placeholder="开始时间" required="required" onclick="fill_value(this)"/>
                                                    </div>
                                                    <div class="col">
                                                        <input type="text" class="form-control" id="datetimepicker4"
                                                            name="actend" placeholder="结束时间" required="required" onclick="fill_value(this)"/>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- TOCHECK: edit 的时候填值，并且 disable 掉 -->
                                            {% if not examine %}
                                            <div class="form-group">
                                                <label>审核老师</label>
                                                <select id="examine_teacher" name="examine_teacher" class="form-control selectpicker" >
                                                    <option value="" selected disabled>选择审核老师</option>
                                                    {% for avialable_teacher in available_teachers %}
                                                        <option value="{{avialable_teacher.name}}">{{avialable_teacher.name}}</option>
                                                    {% endfor %}
                                                </select>

                                            </div>
                                            {% endif %}


                                            <div class="form-check"
                                                style="align-content: center; vertical-align: middle;">
                                                <input class="form-check-input" type="checkbox"
                                                    value="1" id="recorded"
                                                    name="recorded">
                                                <label class="form-check-label" for="defaultCheck1">
                                                    已审核
                                                    <a data-toggle="tooltip" data-placement="bottom" title="已审核活动指学期初已上报学院且获准的活动, 擅自勾选有可能导致小组无法报销或者小组被禁止登录！">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                            class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                            <path
                                                                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                        </svg>
                                                    </a>
                                                </label>

                                            </div>
                                            <hr>
                                            <p>
                                                报名信息
                                                <a data-toggle="tooltip" data-placement="bottom" title="点击报名模式按钮以调整报名模式（如先到先得）。在活动通过审核之后，此项不能修改。">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                        class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                        <path
                                                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                    </svg>
                                                </a>
                                            </p>
                                            <div class="form-group">
                                                <div class="input-group mb-3">
                                                    {% if not edit and not examine or full_editable %}
                                                    <div class="input-group-prepend">
                                                        <button class="btn btn-outline-primary dropdown-toggle"
                                                            type="button" data-toggle="dropdown" aria-haspopup="true"
                                                            aria-expanded="false" id="pricebutton">&nbsp;&nbsp;报名模式&nbsp;&nbsp;
                                                        </button>
                                                        <div class="dropdown-menu">
                                                            <a class="dropdown-item" onclick="shows($(this).text())"
                                                                name="get" value="get">&nbsp;&nbsp;先到先得&nbsp;&nbsp;</a>
                                                            <a class="dropdown-item" onclick="shows($(this).text())"
                                                                id="bid" name="bid" value="bid">&nbsp;&nbsp;抽签模式&nbsp;&nbsp;</a>
                                                        </div>
                                                        <input type="hidden" id="signscheme" name="signscheme"
                                                            value="" />
                                                    </div>
                                                    {% else %}
                                                    <div class="input-group-prepend">
                                                        <button class="btn btn-outline-primary"
                                                            type="button" id="pricebutton"
                                                            aria-expanded="false">&nbsp;&nbsp;{{signscheme}}&nbsp;&nbsp;
                                                        </button>
                                                    </div>
                                                    {% endif %}
                                                    <div class="input-group-prepend">
                                                        <button class="btn btn-outline-primary"
                                                            type="button"
                                                            aria-expanded="false">&nbsp;&nbsp;人数上限&nbsp;&nbsp;
                                                        </button>
                                                    </div>



                                                    <!-- TOCHECK: 如果是 applying 记得设成 disable -->
                                                    <input type="number" id="maxpeople" name="maxpeople"
                                                        class="form-control" aria-label="Default" step="1" min="0" 
                                                        placeholder="人数上限">

                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <div class="row">
                                                    <div class="col">
                                                        <div class="form-check"
                                                            style="align-content: center; vertical-align: middle;">
                                                            <input class="form-check-input" type="checkbox"
                                                                value="1" id="unlimited_capacity"
                                                                name="unlimited_capacity">
                                                            <label class="form-check-label" for="defaultCheck1">
                                                                无人数限制
                                                                <a data-toggle="tooltip" data-placement="bottom" title="无报名人数上限，如面试报名、观赛报名等；可以通过更改人数限制的方式来截止报名">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                                        class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                                        <path
                                                                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                                    </svg>
                                                                </a>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="form-check"
                                                            style="align-content: center; vertical-align: middle;">
                                                            <input class="form-check-input" type="checkbox"
                                                                value="1" id="inner"
                                                                name="inner">
                                                            <label class="form-check-label" for="defaultCheck1">
                                                                内部活动?
                                                                <a data-toggle="tooltip" data-placement="bottom" title="内部活动对所有同学可见，但只有小组内部成员可以报名，且通知只会发送到内部成员。此选项改变时，已有的报名不受影响。">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                                        class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                                        <path
                                                                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                                    </svg>
                                                                </a>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                      
                                            <div class="form-group">
                                                <label for="aintro">
                                                    报名截止于
                                                        <a data-toggle="tooltip" data-placement="bottom" title="在短期内将要开展的活动可以将报名截止时间设定的晚一些，如活动开始前1小时在报名开始后；如果报名人员会经历变动，可以设为1/3天，然后根据情况延长至1小时(系统会重新开放报名)。可以修改截止时间来延长报名">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                            class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                            <path
                                                                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                        </svg>
                                                    </a>
                                                </label>
                                                {% if examine %}
                                                    <input name="examine_apply_end" class="form-control selectpicker" placeholder="{{apply_end}}" disabled>
                                                {% else %}
                                                    {% if not edit %}
                                                    <select id="inputState" name="prepare_scheme" class="form-control selectpicker" >
                                                        <option value="0">活动开始前1小时</option>
                                                        <option value="1" selected>活动开始前1天</option>
                                                        <option value="2">活动开始前3天</option>
                                                        <option value="3">活动开始前1周</option>
                                                    </select>
                                                    {% else %}
                                                    <p>当前报名截止时间为 {{apply_end}}</p>
                                                    <!-- TOCHECK: !(accepted) 时，不能修改-->
                                                    <div class="row">
                                                        <div class="col">
                                                        <select id="inputState" name="prepare_scheme" class="form-control selectpicker">
                                                            <option value="0">活动开始前1小时</option>
                                                            <option value="1" selected>活动开始前1天</option>
                                                            <option value="2">活动开始前3天</option>
                                                            <option value="3">活动开始前1周</option>
                                                        </select>
                                                        </div>
                                                        <div class="col" 
                                                            style="display: flex; flex-direction: column;justify-content: center;text-align: center;">
                                                                <div class="form-check"
                                                                    style="align-content: center; vertical-align: middle;">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        value="1" id="adjust_apply_ddl"
                                                                        name="adjust_apply_ddl">
                                                                    <label class="form-check-label" for="defaultCheck1">
                                                                        调整报名时间
                                                                        <a data-toggle="tooltip" data-placement="bottom" title="勾选此项才可以更改报名时间">
                                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                                                class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                                                <path
                                                                                    d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                                            </svg>
                                                                        </a>
                                                                    </label>

                                                                </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>

                                            <div class="row">
                                                <div class="col">
                                                    <div class="form-check"
                                                        style="align-content: center; vertical-align: middle;">
                                                        <input class="form-check-input" type="checkbox"
                                                            value="1" id="need_checkin"
                                                            name="need_checkin">
                                                        <label class="form-check-label" for="defaultCheck1">
                                                            需要签到?
                                                            <a data-toggle="tooltip" data-placement="bottom" title="若勾选此项，会自动生成在仅活动进行时可用、仅允许活动举办小组在活动页面查看或下载的签到二维码。活动进行时，需要将该二维码展示给同学扫码签到。">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                                    class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                                    <path
                                                                        d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                                </svg>
                                                            </a>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!--
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value=""
                                                    id="whether_record" name="whether_record">
                                                
                                                <label class="form-check-label" for="defaultCheck1">
                                                    活动已备案?
                                                </label>
                                                
                                            </div>
                                            -->
                                            <hr>

                                            <p>宣传信息</p>
                                            <div class="form-group">
                                                <label for="aintro">活动简介</label>
                                                <textarea id="aintro" name="introduction" class="form-control" rows="3"
                                                    placeholder="(必填)简介会随活动基本信息一同推送至订阅者的微信" onclick="fill_value(this)" 
                                                    required="required" maxlength=225></textarea>
                                            </div>
                                            <div class="form-group">
                                                <label for="aintro">
                                                    活动推送链接
                                                    <a data-toggle="tooltip" data-placement="bottom" title="获取链接的方式：在推送中，点击右上角在默认浏览器中打开，然后复制链接填在此处即可。注意，如果是外网链接，请使用以http或https开头的绝对地址。这一项可以在任何时间修改。">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                            class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                            <path
                                                                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                        </svg>
                                                    </a>
                                                </label>
                                                {% if not examine %}
                                                <textarea id="URL" name="URL" class="form-control" rows="3" placeholder="推送链接会和活动通知一起发送；外网链接请使用以http或https开头的绝对地址" onclick="fill_value(this)"></textarea>
                                                {% else %}
                                                <a href="{{url}}"> {{url}} </a>
                                                {% endif %}
                                            </div>


                                            {% if not examine and not edit or full_editable %}
                                            <div class="form-group">
                                                <label>

                                                    活动预告图片

                                                    <a data-toggle="tooltip" data-placement="bottom" title="可以选择默认的图片；如果推送中包含图片的话，也可以选取推送中包含的图片；这一项在审核通过后不可修改">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                                            class="bi bi-question-circle-fill" viewBox="0 0 22 22">
                                                            <path
                                                                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
                                                        </svg>
                                                    </a>
                                                </label><br/>
                                                <div class="col-xl-8 col-lg-8 col-md-7 col-sm-12">
                                                    {% if use_template %}
                                                    <input type="hidden" id="template_id" name="template_id" value="{{template_id}}">
                                                    {% endif %}
                                                    <input onchange="showFilenameLocal(this.files)" type="file" 
                                                           class="custom-file-input" id="images" name="images" 
                                                           accept="image/*" data-max-file-size="4096K">
                                                    <label id="upload_annouce_photo" name="upload_annouce_photo" class="custom-file-label" 
                                                           for="customFile"> 选择历史活动图片或海报或以下默认图片之一 </label>

                                                </div>
                                                
                                            </div>

                                            <div class="form-group">
                                                
                                                <div class="form-check">
                                                    <div class="row">

                                                    {% for pic in defaultpics %}
                                                    <div class="col-xl-4 col-lg-4 col-md-4 mb-5">
                                                        <input class="form-check-input" type="checkbox"
                                                            value={{pic.src}}
                                                            id={{pic.id}} name={{pic.id}}>
                                                        <label class="form-check-label" for="defaultCheck1">
                                                            <img src={{pic.src}} class="img-fluid">
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                    </div>
                                                </div>

                                                
                                            </div>
                                            {% endif %}

                                            {% if not examine %}
                                                {% if edit and not accepted %}
                                                <button type="submit" class="btn btn-primary btn-block mb-4 mr-2" value="" disabled>
                                                    活动{{status}}
                                                </button>
                                                {% elif edit %}
                                                <button type="submit" class="btn btn-primary btn-block mb-4 mr-2" value="" onclick="return confirm('确认修改活动？由于需要发送通知，点击提交后请耐心等待，不要重复点击！')">
                                                    确认修改
                                                </button>
                                                {% else %}
                                                <button type="submit" class="btn btn-primary btn-block mb-4 mr-2" value="" onclick="return confirm('确认提交活动申请？由于需要发送通知，点击提交后请耐心等待，不要重复点击！')">
                                                    发起活动
                                                </button>
                                                {% endif %}
                                            {% endif %}
                                        </form>
                                        {% if examine %}
                                        <!-- 活动图片 -->
                                        <div class="form-group">
                                            <label for="aintro">活动介绍图片</label>
                                            <div class="widget-content widget-content-area">
                                                <img class="d-block w-100" id="examine_pic" src="{{intro_pic}}" alt="Third slide">
                                            </div>
                                        </div>
                                            {% if commentable %}
                                            <form method="POST" role="form" onsubmit="return check_examine()">
                                                <div class="row">
                                                    <div class="col">
                                                    <button type="submit" class="btn btn-primary btn-block mb-4 mr-2"
                                                            name="review_accepted"
                                                            value="2">
                                                        通过
                                                    </button>
                                                    </div>
                                                    <div class="col">
                                                    <button type="submit" class="btn btn-block mb-4 mr-2"
                                                             name="review_reject"
                                                            value="3">
                                                        拒绝
                                                    </button>
                                                    </div>
                                                </div>
                                            </form>
                                            {% else %}
                                            <form method="POST" role="form" >
                                                <button type="submit" class="btn btn-primary btn-block mb-4 mr-2" value="" disabled>
                                                    活动{{status}}
                                                </button>
                                            </form>
                                            {% endif %}
                                        {% endif %}
                                        <div>
                                            {% include 'comment.html' %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            
        </div>
    </div>
    <!--  END CONTENT AREA  -->



{% endblock %}

{% block add_js_file %}
<script src={% static "datetimepicker/js/bootstrap-datetimepicker.min.js" %}></script>


<!-- 主要是一些监控函数 -->
<!-- 根据页面不同，可能会有些多余的函数，但是不影响 js 执行 -->
<script>
    $("input[name='adjust_apply_ddl']").on("change", function () {
        //输出选中状态
        if (false === $(this).prop("checked")) {
            document.getElementById("inputState").disabled = true;
        } else {
            document.getElementById("inputState").disabled = false;
            // document.getElementById("maxpeople").placeholder = "";
        }
    });
    $("input[name='unlimited_capacity']").on("change", function () {
        //输出选中状态
        if (false === $(this).prop("checked")) {
            document.getElementById("maxpeople").disabled = false;
        } else {
            document.getElementById("maxpeople").disabled = true;
            // document.getElementById("maxpeople").placeholder = "";
        }
    });
    $("input[name='recorded']").on("change", function () {
        //输出选中状态
        if (false === $(this).prop("checked")) {
            document.getElementById("college").style.display = "";
        } else {
            document.getElementById("college").style.display = "none";
            document.getElementById("reason_block").style.display = "none";
        }
    });
    {% for pic in defaultpics %}
    $("input[name='{{pic.id}}']").on("change", function () {
        //输出选中状态
        if (true === $(this).prop("checked")) {
            {% for pic in defaultpics %}
            document.getElementById("{{pic.id}}").checked = false;
            {% endfor %}
            document.getElementById("{{pic.id}}").checked = true;
        }
    });
    {% endfor %}

    function showFilenameLocal(files){
        var text = "";
        for (i = 0; i < files.length; i++)
        {
        text += (" "+files[i].name);
        }
        if (text == "")
            text = "选择历史活动图片或海报或以下默认图片之一";
        else {
            {% for pic in defaultpics %}
            document.getElementById("{{pic.id}}").checked = false;
            {% endfor %}
        }
        $("#upload_annouce_photo").html(text);
    }

    function shows(a) {
        $("#pricebutton").text(a);
        if (a.lastIndexOf("先到先得") != -1) {
            document.getElementById("signscheme").value = "0";
        } else {
            document.getElementById("signscheme").value = "1";
        }
    }
</script>

<!-- 选择时间 -->
<script type="text/javascript">
    $(function () {
        $("#datetimepicker1").datetimepicker({
            format: "YYYY-MM-DD HH:mm",
            sideBySide: true,
        });
        $("#datetimepicker2").datetimepicker({
            format: "YYYY-MM-DD HH:mm",
            sideBySide: true
        });
        $("#datetimepicker3").datetimepicker({
            format: "YYYY-MM-DD HH:mm",
            sideBySide: true,
            minDate: new Date(),
        });
        $("#datetimepicker4").datetimepicker({
            format: "YYYY-MM-DD HH:mm",
            sideBySide: true,
            minDate: new Date(),
        });
    });
</script>


{% if use_template %}
<script type="text/javascript">
    document.getElementById("title").value = "{{title | safe}}";
    document.getElementById("location").value = "{{location | safe}}";
    document.getElementById("datetimepicker3").value="{{start}}";
    document.getElementById("datetimepicker4").value="{{end}}";
    document.getElementById("examine_teacher").value="{{examine_teacher}}";
    {% if activity.recorded %}
    document.getElementById("recorded").checked = true;
    document.getElementById("college").style.display = "none";
    document.getElementById("reason_block").style.display = "none";
    {% endif %}
    document.getElementById("pricebutton").innerHTML = "&nbsp;&nbsp;{{signscheme}}&nbsp;&nbsp;";
    if ("{{signscheme}}" == "先到先得") {
        document.getElementById("signscheme").value = "0";
    } else {
        document.getElementById("signscheme").value = "1";
    }
    {% if no_limit %}
    document.getElementById("unlimited_capacity").checked = true;
    document.getElementById("maxpeople").disabled = true;
    {% else %}
    document.getElementById("maxpeople").value = "{{capacity}}";
    {% endif %}
    {% if need_checkin %}
    document.getElementById("need_checkin").checked = true;
    {% endif %}
    {% if inner %}
    document.getElementById("inner").checked = true;
    {% endif %}  
    document.getElementById("aintro").value = "{{introduction | safe}}";
    document.getElementById("inputState").value = {{endbefore}};
    document.getElementById("URL").placeholder = "{{url | safe}}";

    {% if uploaded_photo %}
    document.getElementById("upload_annouce_photo").innerHTML = "{{photo}}";
    {% else %}
    document.getElementById("{{photo_id}}").checked = true;
    {% endif %}
</script>

{% endif %}

<!-- 请求为 edit 或 examine 时执行的脚本， -->
{% if edit or examine %}
<script type="text/javascript">

    /* 提示上传预算信息 */
    if (document.referrer.endsWith("/addActivity/")) {
        document.getElementById("warn_msg").style.display = "";
        document.getElementById("warn_msg").innerHTML = "活动发起成功！如需申请预算，请在评论区上传预算明细。";
    }

    /* 将 palceholder 全部换为旧值，很长很啰嗦 */
    // 但是 Django 是做的文本替换，又必须全写出来......
    // 活动信息
    document.getElementById("title").placeholder = "{{title | safe}}";
    document.getElementById("location").placeholder = "{{location | safe}}";
    document.getElementById("datetimepicker3").placeholder="{{start}}";
    document.getElementById("datetimepicker4").placeholder="{{end}}";
    {% if not examine %}
    document.getElementById("examine_teacher").value="{{examine_teacher}}";
    document.getElementById("examine_teacher").disabled=true;
    {% endif %}
    document.getElementById("recorded").disabled = true;
    {% if activity.recorded %}
    document.getElementById("recorded").checked = true;
    {% endif %}
    // 报名信息 
    document.getElementById("pricebutton").innerHTML = "&nbsp;&nbsp;{{signscheme}}&nbsp;&nbsp;";
    {% if no_limit %}
    document.getElementById("unlimited_capacity").checked = true;
    document.getElementById("maxpeople").disabled = true;
    {% else %}
    document.getElementById("maxpeople").placeholder = "{{capacity}}";
    {% endif %}
    {% if not examine %}
    document.getElementById("inputState").value = {{endbefore}};
    document.getElementById("inputState").disabled = true;
    document.getElementById("URL").placeholder = "{{url | safe}}";
    {% endif %}
    {% if need_checkin %}
    document.getElementById("need_checkin").checked = true;
    {% endif %}
    {% if inner %}
    document.getElementById("inner").checked = true;
    {% endif %}   
    // 宣传信息
    document.getElementById("aintro").placeholder = "{{introduction | safe}}";


    // input 不再必须填写
    var all_inputs = document.getElementsByTagName("input");
    for(var i = 0; i < all_inputs.length; i++){
        all_inputs[i].required="";
    }
    document.getElementById("aintro").required = "";

    /* 填充旧图片 */
    {% if full_editable %}
        {% if uploaded_photo %}
        document.getElementById("upload_annouce_photo").innerHTML = "{{photo}}";
        {% else %}
        document.getElementById("{{photo_id}}").checked = true;
        {% endif %}
    {% endif %}

    
    // 点击自动填充可修改
    {% if edit and accepted %}
    document.getElementById("URL").placeholder = "{{url | safe}}";
    function fill_value(a) {
        if (a.value == "")
            a.value = a.placeholder;
    }

        {% if full_editable %}
            {% if bidding %}
            document.getElementById("signscheme").value = "1";
            {% else %}
            document.getElementById("signscheme").value = "0";
            {% endif %}
        {% else %}
            document.getElementById("title").disabled = true;
        {% endif %}

    {% else %}
        // examine
        var all_inputs = document.getElementsByTagName("input");
        // 最后两项是 hidden input
        for(var i = 0; i < all_inputs.length; i++){
            if (all_inputs[i].type == "hidden" ||  all_inputs[i].type == "file" || all_inputs[i].name == "Query")
                continue;
            all_inputs[i].disabled = true;
        }
        document.getElementById("aintro").disabled = true;
        function fill_value(a) {
            console.log(a.value);
        }
    {% endif %}


</script>
{% else %}
<script type="text/javascript">
    // 没用，只是防止报错影响 js 执行
    function fill_value(a) {
        console.log(a.value);
    }
</script>
{% endif %}

<!-- 检查部分 input 参数 -->
<script type="text/javascript">
    function check_inputs() {
        /*   检查开始与结束时间   */
        var start = document.getElementById("datetimepicker3").value;
        var end = document.getElementById("datetimepicker4").value;
        var now = new Date();
        var prepare_option = document.getElementById("inputState").value;
        if (start == "")
            start = document.getElementById("datetimepicker3").placeholder;
        if (end == "")
            end = document.getElementById("datetimepicker4").placeholder;
        start = new Date(start);
        end = new Date(end);
        // 结束要比开始晚
        if (start >= end) {
            document.getElementById("success_msg").style.display = "none";
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "结束时间要晚于开始时间。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        // 活动要一个月之内，但对于已审核过的活动不做要求
        {% if not accepted %}
        var in_month = new Date();
        in_month = new Date(in_month.setDate(in_month.getDate() + 30));
        if (in_month <= start) {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "活动应在一个月之内申请，晚些再创建吧。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        {% endif %}
        // 创建活动时，要求开始时间 - 准备时间应该晚于当下，即活动必须要能进入 applying 阶段
        {% if not edit %}
        var applyEnd;
        if (prepare_option == "0")
            applyEnd = new Date(start.setHours(start.getHours()-1));
        else if (prepare_option == "1")
            applyEnd = new Date(start.setHours(start.getHours()-24));
        else if (prepare_option == "2")
            applyEnd = new Date(start.setHours(start.getHours()-72));
        else if (prepare_option == "3")
            applyEnd = new Date(start.setHours(start.getHours()-168));
        else
            window.location.href = "/welcome/"
        if (applyEnd < now) {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "没有足够的准备时间（报名截止时间早于当前时间）。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        {% else %}
        var before_start = new Date(start);
        before_start = new Date(before_start.setHours(before_start.getHours()-1));
        // 记不清当时为什么这么写了，先留着
        // var applyEnd = new Date("{{apply_end_for_js}}");
        var applyEnd = new Date("{{apply_end}}");
        if (document.getElementById("adjust_apply_ddl").checked) {
            if (prepare_option == "0")
                applyEnd = new Date(start.setHours(start.getHours()-1));
            else if (prepare_option == "1")
                applyEnd = new Date(start.setHours(start.getHours()-24));
            else if (prepare_option == "2")
                applyEnd = new Date(start.setHours(start.getHours()-72));
            else if (prepare_option == "3")
                applyEnd = new Date(start.setHours(start.getHours()-168));
            else
                window.location.href = "/welcome/"
            // else 的情况：已截止/未截止 -> 未截止
            // 如果是已截止，也不需要提醒，重新开放就是了
        }
        if (applyEnd < now) {
            // 相当于提前截止报名，在这改太麻烦了，在 viewActivity 界面留一个 button 吧
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "修改失败：修改后的报名截止时间早于当前时间。如果是因为希望提前举办活动，请同时修改报名截止时间，谢谢！。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        } 
        if (before_start < applyEnd) {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "活动报名应在活动开始前一小时截止。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        {% endif %}


        /* 非 edit 情况下 */
        {% if not edit %}
        /* 选择了审核老师 */
        if (document.getElementById("examine_teacher").value == "") {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "尚未选择审核老师。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        /* 检查选择了报名方式 */
        var option = document.getElementById("signscheme").value;
        if (option == "") {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "尚未选择报名模式。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        {% endif %}

        /* 检查人数限制 */
        // 如果编辑状态都可以不选
        // 如果非编辑状态，没有人数限制，数量至少填一个
        // 如果是编辑但之前选了无限制，也得至少有一个
        {% if not edit or no_limit %}
        var no_limit = document.getElementById("unlimited_capacity");
        var max_people = document.getElementById("maxpeople");
        console.log(max_people.value);
        if (no_limit.checked == false && max_people.value == "") {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "请设置报名人数限制。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        {% endif %}

        /* 检查图片 */
        {% if not examine and not accepted and not use_template %}
            {% if not edit %}
            if (!(document.getElementById("picture1").checked ||
                document.getElementById("picture2").checked ||
                document.getElementById("picture3").checked ||
                document.getElementById("picture4").checked ||
                document.getElementById("picture5").checked ||
                document.getElementById("images").files.length > 0)
            ) {
                document.getElementById("warn_msg").style.display = "";
                document.getElementById("warn_msg").innerHTML = "选择活动介绍图片。";
                document.body.scrollTop = document.documentElement.scrollTop = 0;
                return false;
            }
            {% endif %}
        if (document.getElementById("images").files.length > 1) {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "仅支持上传一张图片。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        if (document.getElementById("images").files.length == 1) {
            var valid_list = ["jpg", "bmp", "png", "jpeg", "rgb", "tif"];
            var type = document.getElementById("images").files[0].name.split(".").pop().toLowerCase();
            var flag = false;
            for (t in valid_list) {
                if (valid_list[t] == type) {
                    flag = true;
                    break;
                }
            }
            if (!flag) {
                {% if html_display.warn_code == 2 %}
                document.getElementById("success_msg").style.display = "none";
                {% endif %}
                document.getElementById("warn_msg").style.display = "";
                document.getElementById("warn_msg").innerHTML = "不支持的图片格式。";
                document.body.scrollTop = document.documentElement.scrollTop = 0;
                return false;
            } 
        }
        {% endif %}

        /* URL 不要太长，使用 https 协议 */
        var url_value = document.getElementById("URL").value;
        if (url_value.length >= 1000) {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "URL 长度超出上限。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
        if (! url_value == ""){
            if (!url_value.startsWith("http")) {
                {% if html_display.warn_code == 2 %}
                document.getElementById("success_msg").style.display = "none";
                {% endif %}
                document.getElementById("warn_msg").style.display = "";
                document.getElementById("warn_msg").innerHTML = "出于安全性考虑，目前仅支持 http 或 https 协议的 URL。";
                document.body.scrollTop = document.documentElement.scrollTop = 0;
                return false;
            }
        }   


        {% if edit %}
        /* edit 情况下，未填入的 input 补为 placeholder */
        var all_inputs = document.getElementsByTagName("input");
        for(var i = 0; i < all_inputs.length; i++){
            if (all_inputs[i].value == "")
                all_inputs[i].value = all_inputs[i].placeholder;
        }
        if (document.getElementById("aintro").value == "")
            document.getElementById("aintro").value = document.getElementById("aintro").placeholder;
        {% endif %}

        return true;
    }
    {% if examine %}
    function check_examine() {
        // 不要求活动报名时间截止
        return true;
        var applyEnd = new Date("{{apply_end}}")
        var now = new Date()
        if (applyEnd < now) {
            {% if html_display.warn_code == 2 %}
            document.getElementById("success_msg").style.display = "none";
            {% endif %}
            document.getElementById("warn_msg").style.display = "";
            document.getElementById("warn_msg").innerHTML = "活动报名截止时间已过，请通知小组修改。";
            document.body.scrollTop = document.documentElement.scrollTop = 0;
            return false;
        }
    }
    {% endif %}
</script>

{% endblock %}
